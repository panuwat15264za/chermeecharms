<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
    <title>Cheŕmee charm | ออกแบบสร้อย</title>

    <!-- แยก CSS ของหน้า product -->
    <link rel="stylesheet" href="product.css" />
</head>

<body class="productPage">

    <nav class="topnav">
        <a class="brand" href="index.html">Cheŕmee charm</a>
        <div class="links">
            <a href="index.html">Lookbook</a>
            <a class="active" href="product.html">ออกแบบสร้อย</a>
        </div>
    </nav>

    <div class="productWrap">
        <div class="productTop">
            <div class="productTitle">
                <h1>ลองเรียงชาร์มเป็นสร้อย</h1>
                <p>ลากรูปด้านล่างขึ้นมาวางบนกระดาน • ลากชิ้นงานเพื่อขยับ • ดับเบิลคลิกลบ</p>
            </div>

            <div class="productActions">
                <button id="btnCenter" class="soft">จัดเรียงกลาง</button>
                <button id="btnClear" class="soft">ล้างทั้งหมด</button>
                <button id="btnSave">บันทึกรูป</button>
            </div>
        </div>

        <!-- DESIGN BOARD -->
        <div id="board" class="board">
            <div class="boardHint">
                ลากชาร์มมาวางที่นี่ ✨
            </div>

            <div id="baseLayer" class="baseLayer"></div>

            <div class="neckline" aria-hidden="true"></div>
        </div>

        <!-- TRAY -->
        <div class="tray">
            <div class="trayHead">
                <div class="pill">เลือกชาร์มด้านล่างแล้วลากขึ้นไป</div>
            </div>

            <div id="trayList" class="trayList"></div>
        </div>

        <!-- BASE WATCH SELECTOR -->
        <div class="baseBar">
            <div class="pill">เลือกตัวเรือนนาฬิกา</div>
            <div id="baseList" class="baseList"></div>
        </div>

    </div>

    <script>
        (function () {
            const board = document.getElementById('board');
            const tray = document.getElementById('trayList');
            const baseLayer = document.getElementById('baseLayer');
            const baseList = document.getElementById('baseList');

            let BASES = [];
            let selectedBase = null;

            // ===== Utils =====
            const isTouchLike = () => window.matchMedia('(pointer: coarse)').matches;

            function getBoardXY(clientX, clientY) {
                const rect = board.getBoundingClientRect();
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top,
                    rect
                };
            }

            // ===== Lock/Unlock scroll (iOS fix) =====
            let scrollYBeforeLock = 0;
            function lockScroll() {
                scrollYBeforeLock = window.scrollY || 0;
                document.documentElement.classList.add('lockScroll');
                document.body.classList.add('lockScroll');
                document.body.style.top = `-${scrollYBeforeLock}px`;
            }

            function unlockScroll() {
                document.documentElement.classList.remove('lockScroll');
                document.body.classList.remove('lockScroll');

                const top = document.body.style.top;
                document.body.style.top = '';
                const y = top ? -parseInt(top, 10) : scrollYBeforeLock;
                window.scrollTo(0, y);
            }

            // ===== Load Bases =====
            async function loadBaseFromJson() {
                try {
                    const res = await fetch('bases.json', { cache: 'no-store' });
                    if (!res.ok) throw new Error('โหลด bases.json ไม่สำเร็จ: ' + res.status);

                    const data = await res.json();
                    const basePath = data.basePath || '';
                    const files = Array.isArray(data.files) ? data.files : [];

                    BASES = files.map((name, i) => ({
                        name: `Base ${i + 1}`,
                        src: basePath + name
                    }));

                    renderBaseList();
                } catch (err) {
                    console.error(err);
                    baseList.innerHTML = `<div style="color:rgba(255,255,255,.75);padding:6px 2px">
                  ไม่พบ bases.json หรือโหลดไม่ได้ — กรุณาเช็คว่า bases.json อยู่ข้างๆ product.html
                </div>`;
                    baseLayer.innerHTML = '';
                }
            }

            function renderBaseList() {
                baseList.innerHTML = "";
                BASES.forEach((b, idx) => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "baseItem";
                    btn.innerHTML = `<img src="${b.src}" alt="${b.name}">`;
                    btn.addEventListener("click", () => setBase(idx));
                    baseList.appendChild(btn);
                });
                // ✅ ไม่ต้องโชว์ base ก่อน กดเลือกค่อยขึ้น
            }

            function setBase(index) {
                selectedBase = BASES[index];

                [...baseList.querySelectorAll(".baseItem")].forEach((el, i) => {
                    el.classList.toggle("active", i === index);
                });

                baseLayer.innerHTML = "";
                if (!selectedBase) return;

                const basePiece = document.createElement("div");
                basePiece.className = "basePiece";

                const br = board.getBoundingClientRect();
                basePiece.style.left = (br.width / 2 - 150) + "px";
                basePiece.style.top = (br.height / 2 - 80) + "px";

                const img = document.createElement("img");
                img.src = selectedBase.src;
                img.alt = selectedBase.name;
                img.draggable = false;

                basePiece.appendChild(img);
                baseLayer.appendChild(basePiece);

                enableDragInsideBoard(basePiece, { isBase: true });
            }

            // ===== Load Charms =====
            async function loadTrayFromJson() {
                try {
                    const res = await fetch('images.json', { cache: 'no-store' });
                    if (!res.ok) throw new Error('โหลด images.json ไม่สำเร็จ: ' + res.status);

                    const data = await res.json();
                    const base = data.basePath || '';
                    const files = Array.isArray(data.files) ? data.files : [];

                    tray.innerHTML = '';

                    files.forEach((name) => {
                        const img = document.createElement('img');
                        img.className = 'charm';
                        img.draggable = !isTouchLike(); // ✅ มือถือไม่ใช้ drag html5
                        img.loading = 'lazy';
                        img.src = base + name;
                        img.alt = name;
                        tray.appendChild(img);
                    });

                } catch (err) {
                    console.error(err);
                    tray.innerHTML = `<div style="color:rgba(255,255,255,.75);padding:10px">
                  ไม่พบ images.json หรือโหลดไม่ได้ — กรุณาเช็คว่า images.json อยู่ข้างๆ product.html
                </div>`;
                }
            }

            // ===== Desktop Drag&Drop (ยังใช้ได้) =====
            tray.addEventListener('dragstart', (e) => {
                const img = e.target.closest('img.charm');
                if (!img) return;

                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('text/plain', img.src);
                e.dataTransfer.setData('text/uri-list', img.src);
            });

            board.addEventListener('dragover', (e) => {
                e.preventDefault();
                board.classList.add('dragOver');
                e.dataTransfer.dropEffect = 'copy';
            });

            board.addEventListener('dragleave', () => board.classList.remove('dragOver'));

            board.addEventListener('drop', (e) => {
                e.preventDefault();
                board.classList.remove('dragOver');

                const src = e.dataTransfer.getData('text/plain');
                if (!src) return;

                const { x, y } = getBoardXY(e.clientX, e.clientY);
                addCharmPiece(src, x, y);
            });

            // ===== Mobile Pointer Drag from Tray (แก้หลุด + กัน scroll) =====
            let ghost = null;
            let draggingSrc = null;
            let dragging = false;

            function moveGhost(x, y) {
                if (!ghost) return;
                ghost.style.left = (x - 26) + 'px';
                ghost.style.top = (y - 26) + 'px';

                const br = board.getBoundingClientRect();
                const inside = x >= br.left && x <= br.right && y >= br.top && y <= br.bottom;
                board.classList.toggle('dragOver', inside);
            }

            function finishMobileDrop(clientX, clientY) {
                const br = board.getBoundingClientRect();
                const inside = clientX >= br.left && clientX <= br.right && clientY >= br.top && clientY <= br.bottom;

                if (inside && draggingSrc) {
                    const { x, y } = getBoardXY(clientX, clientY);
                    addCharmPiece(draggingSrc, x, y);
                }
                cleanupMobileDrag();
            }

            function cleanupMobileDrag() {
                dragging = false;
                draggingSrc = null;
                board.classList.remove('dragOver');
                if (ghost) ghost.remove();
                ghost = null;

                window.removeEventListener('pointermove', onMobileMove, { passive: false });
                window.removeEventListener('pointerup', onMobileUp, { passive: false });
                window.removeEventListener('pointercancel', onMobileCancel, { passive: false });

                unlockScroll();
            }

            function onMobileMove(e) {
                if (!dragging) return;
                e.preventDefault();
                moveGhost(e.clientX, e.clientY);
            }

            function onMobileUp(e) {
                if (!dragging) return;
                e.preventDefault();
                finishMobileDrop(e.clientX, e.clientY);
            }

            function onMobileCancel(e) {
                if (!dragging) return;
                e.preventDefault();
                cleanupMobileDrag();
            }

            tray.addEventListener('pointerdown', (e) => {
                const img = e.target.closest('img.charm');
                if (!img) return;
                if (!isTouchLike()) return;

                e.preventDefault();
                dragging = true;
                draggingSrc = img.src;

                lockScroll();

                ghost = document.createElement('img');
                ghost.src = draggingSrc;
                ghost.className = 'dragGhost';
                document.body.appendChild(ghost);

                moveGhost(e.clientX, e.clientY);

                // ✅ ฟังที่ window เพื่อไม่ให้หลุดตอนลากออกจาก tray
                window.addEventListener('pointermove', onMobileMove, { passive: false });
                window.addEventListener('pointerup', onMobileUp, { passive: false });
                window.addEventListener('pointercancel', onMobileCancel, { passive: false });
            }, { passive: false });

            // ===== Create Charm Piece =====
            function addCharmPiece(src, x, y) {
                const hint = board.querySelector('.boardHint');
                if (hint) hint.style.display = 'none';

                const piece = document.createElement('div');
                piece.className = 'piece';
                piece.style.left = (x - 28) + 'px';
                piece.style.top = (y - 28) + 'px';

                const img = document.createElement('img');
                img.src = src;
                img.alt = 'charm piece';
                img.draggable = false;

                piece.appendChild(img);
                board.appendChild(piece);

                enableDragInsideBoard(piece, { isBase: false });

                piece.addEventListener('dblclick', () => removePiece(piece));
                addLongPressToRemove(piece);
            }

            function removePiece(piece) {
                piece.remove();
                if (!board.querySelector('.piece')) {
                    const hint2 = board.querySelector('.boardHint');
                    if (hint2) hint2.style.display = '';
                }
            }

            function addLongPressToRemove(el) {
                let t = null;
                el.addEventListener('pointerdown', () => {
                    if (!isTouchLike()) return;
                    t = setTimeout(() => {
                        el.remove();
                    }, 600);
                }, { passive: true });

                el.addEventListener('pointerup', () => { if (t) clearTimeout(t); t = null; }, { passive: true });
                el.addEventListener('pointercancel', () => { if (t) clearTimeout(t); t = null; }, { passive: true });
                el.addEventListener('pointermove', () => { if (t) clearTimeout(t); t = null; }, { passive: true });
            }

            // ===== Drag inside board (ใช้ได้ทั้ง charm และ base) =====
            function enableDragInsideBoard(piece, { isBase = false } = {}) {
                let dragging = false;
                let offsetX = 0, offsetY = 0;

                piece.addEventListener('pointerdown', (e) => {
                    e.preventDefault();

                    if (isTouchLike()) lockScroll();

                    dragging = true;
                    piece.setPointerCapture(e.pointerId);
                    piece.classList.add('active');

                    const pr = piece.getBoundingClientRect();
                    offsetX = e.clientX - pr.left;
                    offsetY = e.clientY - pr.top;

                    if (isBase) piece.style.zIndex = 5;
                }, { passive: false });

                piece.addEventListener('pointermove', (e) => {
                    if (!dragging) return;
                    e.preventDefault();

                    const br = board.getBoundingClientRect();
                    let nx = e.clientX - br.left - offsetX;
                    let ny = e.clientY - br.top - offsetY;

                    const w = piece.offsetWidth;
                    const h = piece.offsetHeight;

                    nx = Math.max(0, Math.min(nx, br.width - w));
                    ny = Math.max(0, Math.min(ny, br.height - h));

                    piece.style.left = nx + 'px';
                    piece.style.top = ny + 'px';
                    piece.style.transform = '';
                }, { passive: false });

                piece.addEventListener('pointerup', () => {
                    dragging = false;
                    piece.classList.remove('active');
                    if (isTouchLike()) unlockScroll();
                });

                piece.addEventListener('pointercancel', () => {
                    dragging = false;
                    piece.classList.remove('active');
                    if (isTouchLike()) unlockScroll();
                });
            }

            // ===== Actions =====
            document.getElementById('btnClear').addEventListener('click', () => {
                board.querySelectorAll('.piece').forEach(n => n.remove());
                baseLayer.innerHTML = '';
                [...baseList.querySelectorAll(".baseItem")].forEach(el => el.classList.remove("active"));
                const hint = board.querySelector('.boardHint');
                if (hint) hint.style.display = '';
            });

            document.getElementById('btnCenter').addEventListener('click', () => {
                const pieces = Array.from(board.querySelectorAll('.piece'));
                if (!pieces.length) return;

                const br = board.getBoundingClientRect();
                const midY = br.height * 0.52;
                const gap = 10;

                const totalW = pieces.reduce((sum, p) => sum + p.offsetWidth, 0) + gap * (pieces.length - 1);
                let startX = (br.width - totalW) / 2;
                startX = Math.max(10, startX);

                pieces.forEach((p) => {
                    p.style.left = startX + 'px';
                    p.style.top = (midY - p.offsetHeight / 2) + 'px';
                    startX += p.offsetWidth + gap;
                });
            });

            document.getElementById('btnSave').addEventListener('click', () => window.print());

            // init
            loadTrayFromJson();
            loadBaseFromJson();
        })();
    </script>
</body>

</html>